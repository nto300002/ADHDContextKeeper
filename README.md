**前提:**

- **プラットフォーム:** デスクトップアプリ (Electron + React + TypeScript)
- **AI 連携:** Gemini API
- **ターゲットユーザー:** ADHD 傾向のあるクリエイティブ系ユーザー

---

**アプリ要件定義（改訂版）**

**1. アプリの概要**

- **1.1. アプリケーション名称:**

  - ADHDContextKeeper

- **1.2. アプリケーションの目的とゴール:**

  - ADHD傾向や短期記憶に困難を抱えるクリエイティブ系のユーザー（デザイナー、プログラマー、ライターなど）が、PCでの複雑な作業中に現在の思考やタスクの流れを見失うことを防ぎ、スムーズな作業継続を支援する。
  - ユーザーが「今、何をしていたか」「次に何をすべきか」を迅速かつ客観的に把握できるよう、スクリーンショット、OCR、AI（Gemini API等）を活用して作業コンテキストを記録・分析し、具体的な気づきや次の行動への指針を提供する。
  - 思考の断片化を最小限に抑え、集中力の維持と生産性の向上に貢献する。

- **1.3. ターゲットユーザー:**

  - ADHDの診断を受けている、またはその傾向を自覚しており、短期記憶やワーキングメモリの課題を感じているPCユーザー。
  - 特に、エラーログの解析、コーディング、デザイン制作、情報収集、資料作成など、複数の情報や手順を扱う思考集約型の作業を頻繁に行うクリエイターや開発者。
  - マルチタスクが多く、注意が散漫になりやすいと感じている人。

- **1.4. 解決する主要な課題:**

  - 作業中断時や思考が飛んだ際に、「直前まで何をしていたか」「何を考えていたか」を思い出すことの困難さ。
  - エラーメッセージや参照情報など、一時的に表示された複雑な情報を後から正確に把握し、次のアクションに繋げることの難しさ。
  - 複数の情報源や思考の断片が整理されず、作業の全体像や次のステップが見えにくくなること。

- **1.5. 提供価値:**
  - **作業コンテキストの外部化:** 「頭の中」の短期記憶への負荷を軽減し、アプリが「第二の脳」の一部として機能。
  - **迅速な状況把握と作業再開:** 混乱時や作業再開時に、AIによる客観的な分析と整理された情報によって素早く現在の状況を理解。
  - **行動促進:** 次の具体的なアクションの提案により、思考停止や先延ばしを防ぎ、作業の流れをスムーズにする。
  - **精神的負担の軽減:** 「忘れてしまうかもしれない」という不安を減らし、安心して作業に集中できる環境を提供。

**2. 主要機能**

- **2.1. インテリジェント・スナップショット機能:**

  - **2.1.1. クイックキャプチャ:**
    - **トリガー:** ユーザー定義可能なグローバルショートカットキー、またはアプリ内ボタン。
    - **対象:** アクティブウィンドウ、フルスクリーン、またはユーザー選択範囲のスクリーンショットを即座に取得。
  - **2.1.2. 自動OCR処理:**
    - キャプチャした画像から高精度でテキスト情報を自動抽出（日本語・英語対応）。
  - **2.1.3. コンテキスト自動記録:**
    - スナップショット取得時のアクティブウィンドウのタイトル、アプリケーション名、可能であればURL（ブラウザの場合）を自動で記録。
  - **2.1.4. データ保存 (ローカルDB & オプションクラウド):**
    - OCRテキスト、コンテキスト情報、スナップショット画像（クラウドストレージ連携時またはローカルパス）、タイムスタンプ、ユーザーメモ、タグ、カテゴリ、AI分析結果などをローカルデータベースに保存。
    - スクリーンショット画像本体は、ユーザー選択により指定のクラウドストレージ（例: Google Drive等、ユーザー自身のアカウント）に保存・同期するオプションを提供（プライバシーとユーザーコントロールを重視）。

- **2.2. AIによる状況整理・行動サジェスト機能 (Gemini API等連携):**

  - **2.2.1. シングルスナップショット分析:**
    - 記録された単一スナップショットのOCRテキスト、コンテキスト情報、ユーザーメモをAIに送信。
    - AIが「現在の状況の要約」「考えられる思考のポイント」「次に行うべき具体的な行動提案（2～3個）」を生成し、アプリ内に表示。
  - **2.2.2. 複数スナップショット連携分析:**
    - ユーザーがアプリ内で複数の関連するスナップショットを選択。
    - 選択された情報群をAIに送信し、一連の作業の流れや複数の情報源からの総合的な判断に基づき、より深い状況整理と次の行動提案を生成。
  - **2.2.3. 手動コンテキスト入力からの分析:**
    - スクリーンショットなしで、ユーザーがテキストで現在の課題や思考、質問などを直接入力。
    - 入力されたテキストをAIに送信し、同様に状況整理と行動提案を生成。
  - **2.2.4. プロンプトテンプレート機能:**
    - ユーザーが目的に応じてAIへの指示（プロンプト）のテンプレートを作成・保存し、分析時に利用できる機能。これにより、定型的な分析を効率化し、AIの出力をより目的に沿ったものにする。

- **2.3. スナップショット管理・検索機能:**

  - **2.3.1. スナップショット一覧表示:**
    - タイムライン形式やリスト形式で、スナップショットをサムネイル、タイトル、日時、主要タグなどと共に表示。
    - 「今日」「過去7日間」などの期間別フィルタや、カテゴリ・タグによるフィルタリング。
  - **2.3.2. 詳細表示・編集:**
    - キャプチャ画像、編集可能なOCRテキスト、コンテキスト情報、AI分析結果、ユーザーメモ、タグ、カテゴリなどを統合的に表示・編集。
  - **2.3.3. 強力な検索機能:**
    - OCRテキスト、ユーザーメモ、タグ、カテゴリ、ウィンドウタイトル、アプリケーション名、日時など、様々な条件で過去のスナップショットを横断的に検索。
  - **2.3.4. カテゴリ・タグ管理:**
    - ユーザーが自由にカテゴリやタグを作成・編集・削除し、スナップショットに柔軟に付与。AIによるタグの自動サジェストも検討。

- **2.4. ユーザーインターフェースと体験 (UI/UX):**

  - **2.4.1. シンプルかつ直感的な操作性:** ADHD特性に配慮し、情報過多を避け、視覚的ノイズが少ないクリーンなデザイン。
  - **2.4.2. 低負荷な記録プロセス:** ショートカットキー一発など、作業の流れを極力中断させない簡単な操作で記録を完了。
  - **2.4.3. 迅速な情報アクセス:** 必要な情報やAIの分析結果に素早くアクセスでき、視覚的に理解しやすい表示。
  - **2.4.4. カスタマイズ性:** 自動削除ポリシー、通知設定、APIキー設定など、ユーザーが自身の使い方に合わせて調整できるオプションを提供。

- **2.5. 対応プラットフォームと技術:**
  - **対応OS:** macOS、Windows。
  - **実装技術（想定）:** Electron、React、TypeScript、Node.js、SQLite。

---

**UI デザイン案からの考察と修正点:**

- **全体的な印象:** ダークモードで落ち着いた雰囲気。情報が整理されていて見やすいです。
- **左サイドバー:**
  - 「Cloud」: クラウド同期の状態を示すか、クラウド上のファイルブラウザ機能か。初期 v0 ではローカル主体とし、クラウド同期はオプションとすることを考えると、まずは設定でクラウド連携を ON/OFF できるようにし、同期ステータスを示す程度が良いかもしれません。
  - 「メモ」: 現在の主要な作業スペース。スナップショットの一覧が表示されるエリア。
  - 「カテゴリ」: カテゴリ管理やカテゴリごとのスナップショット表示への導線。
  - 「新規フォルダ」: 現状の要件では「フォルダ」という概念は明示的に出ていませんでした。「カテゴリ」でグルーピングし、さらに細分化したい場合に「プロジェクト」や「サブカテゴリ」のような概念として導入するか、あるいはシンプルにタグ付けで対応するか検討が必要です。ひとまず、v0 ではカテゴリとタグによる整理を主軸とし、「フォルダ」は将来的な拡張とするか、より具体的なニーズが出てきた際に検討します。
- **中央上部アイコン群:**
  - リスト表示/グリッド表示切替: スナップショット一覧の表示形式変更。良い機能です。
  - ゴミ箱: 削除済みアイテムの確認・復元機能か、あるいは一括削除機能か。
  - 設定: アプリ全体の設定ページへの導線。
  - 検索: スナップショット検索。
- **中央コンテンツエリア (左側 - 履歴リスト):**
  - 「今日」「過去 7 日間」といった時系列でのグルーピングは分かりやすいです。
  - 「7 日を過ぎると自動削除されます」: このポリシーは設定で変更可能にすべきです。また、ローカル保存アイテムのみを対象とするのか、クラウド保存アイテムも対象とするのか明確にする必要があります。v0 では「ローカルアイテムを対象とし、期間は設定で変更可能」が良いでしょう。
  - 「アイテム（ローカル保存）」: この表示は、クラウド同期機能が ON の場合に、ローカルにしかないアイテムを明示する意図でしょうか。シンプルにするなら、クラウド同期状態は各アイテムにアイコン等で示す方が良いかもしれません。
- **中央コンテンツエリア (右側 - 詳細表示):**
  - 「画像の日付」: スナップショットのタイトル（自動生成 or 手動編集可能）。
  - 「画像」プレースホルダー: スクリーンショット画像表示。
  - 「タグ」: 付与されたタグ。クリックでフィルタリングなども考えられます。
  - 「読み取ったコンテキスト」: OCR 結果。ハイライトされている部分は、ユーザーが重要だとマークした部分か、AI が重要だと判断した部分でしょうか。
  - 「次の行動: 出力」: ここが Gemini API によるサジェスト結果の表示エリアになりそうです。
  - 「OO Error の解決 @OO.py @OO.py」: これはユーザーが追記したメモや、AI が生成した具体的な解決策の候補でしょうか。
  - 「アイテム詳細」ボタン: おそらく編集モードへの切り替えや、より詳細な情報（メタデータなど）を表示する機能でしょう。
- **2 枚目の画像 (設定ページ or 詳細編集ページ):**
  - 「タグ」セクション: タグの管理（追加、編集、削除）。
  - 「テンプレート」セクション: これはプロンプトテンプレート（Gemini API に投げる指示の雛形）をユーザーがカスタマイズできる機能と解釈できます。非常に有用な機能です。例えば、「このエラーログを解析して、考えられる原因を 3 つ挙げてください」のようなテンプレートを保存しておき、スナップショットごとに適用できるようにするなど。

**詳細設計:**

---

**A. フロントエンド詳細設計 (React + TypeScript)**

1.  **ディレクトリ構造 (例):**

    ```
    src/
    ├── main.tsx              # アプリケーションエントリー
    ├── App.tsx               # メインコンポーネント、ルーティング
    ├── components/           # 共通UIコンポーネント
    │   ├── Sidebar.tsx
    │   ├── Header.tsx
    │   ├── SnapshotList.tsx
    │   ├── SnapshotItem.tsx
    │   ├── SnapshotDetailView.tsx
    │   ├── SettingsView.tsx
    │   ├── TagInput.tsx
    │   └── PromptTemplateEditor.tsx
    ├── pages/                # 主要ページコンポーネント
    │   ├── MainPage.tsx
    │   └── SettingsPage.tsx
    ├── services/             # API連携など (ElectronのipcRenderer経由)
    │   ├── snapshotService.ts
    │   ├── ocrService.ts
    │   ├── aiService.ts
    │   └── settingsService.ts
    ├── store/                # 状態管理 (Zustand, Redux Toolkitなど)
    │   ├── snapshotStore.ts
    │   └── settingsStore.ts
    ├── hooks/                # カスタムフック
    ├── utils/                # ユーティリティ関数
    └── styles/               # グローバルスタイル、テーマ
    ```

2.  **主要コンポーネント詳細:**

    - **`App.tsx`:**
      - `react-router-dom` を用いたルーティング設定 (`/`, `/settings` など)。
      - グローバルな状態管理の初期化。
      - Electron のメインプロセスからのイベントリスナー設定（例: グローバルショートカット経由でのキャプチャ指示）。
    - **`Sidebar.tsx`:**
      - ナビゲーションリンク（メモ、カテゴリ、設定）。
      - 選択状態のハイライト。
      - 「新規フォルダ」は v1 以降で検討。
    - **`Header.tsx`:**
      - 日付表示。
      - 表示モード切替ボタン（リスト/グリッド）。
      - 検索入力フィールドと実行ボタン。
      - 設定ページへのナビゲーションボタン。
      - ゴミ箱機能は v1 以降で検討（まずは単純削除）。
    - **`SnapshotList.tsx`:**
      - `snapshotStore` からスナップショット一覧を取得・表示。
      - フィルタリング条件（期間、検索キーワード、カテゴリ、タグ）に基づいて表示を更新。
      - スクロール、ページネーション（または仮想スクロール）。
      - 各スナップショットを `SnapshotItem.tsx` でレンダリング。
      - アイテム選択時の処理（`SnapshotDetailView` への情報連携）。
    - **`SnapshotItem.tsx`:**
      - スナップショットの概要情報（サムネイル、タイトル、日時、主要タグ）を表示。
      - 選択状態の表示。
      - クリックで詳細表示エリアに情報を送る。
    - **`SnapshotDetailView.tsx`:**
      - 選択されたスナップショットの詳細情報を表示。
      - 画像表示エリア (クリックで拡大表示も検討)。
      - OCR テキスト表示エリア（編集可能にすることも検討）。
      - タグ表示・編集エリア (`TagInput.tsx` を使用)。
      - ユーザーメモ入力エリア。
      - Gemini API 分析結果表示エリア（「次の行動」など）。
      - 「AI に分析させる」ボタン（手動での再分析や、プロンプトテンプレート選択）。
      - 削除ボタン。
    - **`SettingsView.tsx` (SettingsPage 内で使用):**
      - **一般設定:**
        - ダークモード/ライトモード切替。
        - 自動削除ポリシー（期間、ON/OFF）。
        - デフォルトのキャプチャモード（アクティブウィンドウ/フルスクリーン）。
      - **アカウント/クラウド設定:**
        - クラウドストレージ連携設定（v1 以降）。
        - Gemini API キー入力欄。
      - **タグ管理:** タグの一覧、追加、編集、削除。
      - **プロンプトテンプレート管理 (`PromptTemplateEditor.tsx` を使用):** テンプレート一覧、作成、編集、削除。
    - **`TagInput.tsx`:**
      - タグの入力と表示を行うコンポーネント。サジェスト機能。
    - **`PromptTemplateEditor.tsx`:**
      - プロンプトテンプレートの作成・編集 UI。変数（例: `{ocr_text}`）を埋め込めるようにする。

3.  **状態管理 (`snapshotStore`, `settingsStore`など):**

    - スナップショットデータ（一覧、選択中のもの）。
    - アプリケーション設定（API キー、表示設定、自動削除ポリシーなど）。
    - UI の状態（ローディング中、エラー表示など）。
    - カテゴリ一覧、タグ一覧、プロンプトテンプレート一覧。

4.  **API 連携 (`services/`):**
    - Electron の`ipcRenderer.invoke` や `ipcRenderer.on` を使用してメインプロセス（バックエンド）と通信。
    - 例: `snapshotService.createSnapshot(imageData, windowTitle)` は内部で `ipcRenderer.invoke('create-snapshot', ...)` を呼び出す。

---

**B. バックエンド詳細設計 (Electron Main Process - Node.js + TypeScript)**

1.  **ディレクトリ構造 (例):**

    ```
    electron/
    ├── main.ts                 # Electronメインプロセスエントリー
    ├── preload.ts              # プレロードスクリプト
    ├── modules/                # バックエンドロジック
    │   ├── database.ts         # SQLiteデータベース処理
    │   ├── capture.ts          # スクリーンショット取得処理
    │   ├── ocr.ts              # OCR処理 (Tesseract.jsなど)
    │   ├── ai.ts               # Gemini API連携処理
    │   ├── fileStorage.ts      # (クラウド)ファイルストレージ処理
    │   ├── settingsManager.ts  # 設定管理
    │   └── autoDelete.ts       # 自動削除処理
    └── ipcHandlers.ts          # IPCイベントハンドラ登録
    ```

2.  **主要モジュール詳細:**

    - **`main.ts`:**
      - `BrowserWindow` の作成と管理。
      - グローバルショートカットの登録 (`globalShortcut`)。
      - `ipcHandlers.ts` の初期化。
      - アプリケーションライフサイクルイベントの処理。
    - **`database.ts` (SQLite):**
      - **スキーマ定義:**
        - `snapshots`: `id` (PK), `title` (TEXT), `image_path` (TEXT, ローカルパス or クラウド識別子), `ocr_text` (TEXT), `captured_at` (DATETIME), `window_title` (TEXT), `app_name` (TEXT), `source_url` (TEXT, nullable), `user_memo` (TEXT, nullable), `ai_summary` (TEXT, nullable), `ai_actions` (TEXT, JSON 形式で複数の提案), `category_id` (FK, nullable), `is_synced` (BOOLEAN, クラウド同期状態), `created_at`, `updated_at`
        - `categories`: `id` (PK), `name` (TEXT UNIQUE), `created_at`, `updated_at`
        - `tags`: `id` (PK), `name` (TEXT UNIQUE), `created_at`, `updated_at`
        - `snapshot_tags`: `snapshot_id` (FK), `tag_id` (FK), PRIMARY KEY (`snapshot_id`, `tag_id`)
        - `prompt_templates`: `id` (PK), `name` (TEXT), `template_string` (TEXT), `created_at`, `updated_at`
        - `settings`: `key` (TEXT UNIQUE PK), `value` (TEXT)
      - CRUD 操作関数群（スナップショット、カテゴリ、タグ、テンプレート、設定）。
    - **`capture.ts`:**
      - `desktopCapturer` API を使用してスクリーンショット（アクティブウィンドウ、フルスクリーンなど）を取得。
      - アクティブウィンドウ情報の取得 (`active-win` ライブラリなど)。
    - **`ocr.ts`:**
      - `Tesseract.js` などを使用して画像データからテキストを抽出。
      - 言語設定の考慮。
    - **`ai.ts`:**
      - `google-generative-ai` SDK を使用。
      - ユーザー設定から Gemini API キーを取得。
      - プロンプトテンプレートと OCR テキスト、コンテキスト情報を組み合わせてプロンプトを生成。
      - Gemini API にリクエストを送信し、結果（要約、行動提案など）を取得。
      - エラーハンドリング（API エラー、コンテンツフィルターなど）。
    - **`fileStorage.ts`:**
      - ローカルへの画像ファイル保存。
      - （v1 以降）クラウドストレージ（Google Drive 等）への画像アップロード・ダウンロード。認証処理。
    - **`settingsManager.ts`:**
      - `settings` テーブルから各種設定値を読み込み、フロントエンドに提供。
      - 設定値の保存。
    - **`autoDelete.ts`:**
      - 設定に基づいて、古いローカルスナップショットを定期的に削除する処理（例: アプリ起動時、またはタイマー）。
    - **`ipcHandlers.ts`:**
      - `ipcMain.handle` や `ipcMain.on` を使用して、フロントエンドからのリクエストを処理する関数を登録。
        - `'capture-and-create-snapshot'`: キャプチャ →OCR→DB 保存 →AI 分析の一連の処理。
        - `'get-snapshots'`: スナップショット一覧取得（フィルタリング条件付き）。
        - `'get-snapshot-detail'`: 特定スナップショットの詳細取得。
        - `'update-snapshot'`: スナップショット情報（メモ、タグなど）更新。
        - `'delete-snapshot'`: スナップショット削除。
        - `'analyze-with-ai'`: 特定スナップショットを AI で再分析。
        - `'analyze-manual-context'`: 手動入力テキストを AI で分析。
        - カテゴリ、タグ、プロンプトテンプレートの CRUD 操作用ハンドラ。
        - 設定の取得・保存用ハンドラ。

3.  **処理フローの例 (ショートカットキーでのスナップショット作成):**
    1.  ユーザーがグローバルショートカットキーを押す。
    2.  Electron `main.ts` がショートカットを検知。
    3.  `capture.ts` がアクティブウィンドウのスクリーンショットとウィンドウ情報を取得。
    4.  `ocr.ts` が画像からテキストを抽出。
    5.  `fileStorage.ts` が画像をローカルに保存。
    6.  `database.ts` がスナップショット情報（OCR テキスト、画像パス、コンテキスト情報など）を DB に保存。
    7.  （オプション: 設定で自動分析が ON の場合）`ai.ts` が OCR テキストとコンテキスト情報を使って Gemini API にリクエストを送信。
    8.  `ai.ts` が結果（要約、行動提案）を取得し、`database.ts` を介して該当スナップショットの情報を更新。
    9.  フロントエンドに新しいスナップショットが作成されたことを通知 (`webContents.send`)。
    10. フロントエンドが `snapshotStore` を更新し、UI に反映。
